function EVA_Player_Cover(e,t){this.max=1,this.pos=0,this.title="加载中...",this.enough_to_display=!1,this.root=$node("wrapper_cover"),this.root.style.width=e+"px",this.root.style.height=t+"px",this.show=function(i,n,a){function o(e){e<c.length&&($node(c[e]).style.display="block",$node(c[e]).className="effect_fadeIn",window.setTimeout(function(){o(e+1)},300))}this.root.className="",this.enough_to_display=!1,$node("album_title").innerText=i,$node("wrapper_player_cover_bkgnd").style.height=t-52+"px";var r=$node("wrapper_player_cover_bkgnd").getElementsByTagName("img")[0],l=e,s=t-52,_=new Image;_.onload=function(){r.src=a;var e=calcImgClip(l,s,_.width,_.height);r.style.left=0-e.clipLeft+"px",r.style.top=0-e.clipTop+"px",r.style.width=e.objWidth+"px",r.style.height=e.objHeight+"px",r.style.clip="rect("+e.clipTop+"px "+Math.floor(e.clipLeft+l)+"px "+Math.floor(e.clipTop+s)+"px "+e.clipLeft+"px)"},_.src=a,this.root.style.display="block";var c=["album_title"];o(0);var u=this;window.setTimeout(function(){u.enough_to_display=!0},2e3)},this.setRange=function(e){this.max=e,this.updateProgress(this.pos)},this.updateProgress=function(e){this.pos=e;var t=$node("div_player_loadingText").getElementsByTagName("span")[0];t.innerText=this.title+"("+this.pos+"/"+this.max+")",e==this.max&&($node("div_player_loadingText").style.display="none")},this.checkReadyToHide=function(e){var t=this;1==this.enough_to_display?(this.root.addEventListener("webkitAnimationEnd",function(){t.root.style["pointer-events"]="none"},!1),TTXP_Animation_Mgr.animate(this.root,{animates:[{name:"kf_fadeOut",duration:2,delay:0,timing:"ease"}],end:function(e){e.style.display="none",$(e).remove()}}),e()):setTimeout(function(){t.checkReadyToHide(e)},100)},this.hide=function(e){this.checkReadyToHide(e)}}function EVA_Player(player_div_id,maxWidth,maxHeight){var __LOG_TAG__="TTXP_Album_Player",template_script_ready_=!1,canvasWidth_=maxWidth,canvasHeight_=maxHeight,loadingImgCount_=0,player_canvas_id_=player_div_id,real_playerCreator_="",realPlayerObj_=null,loader_=new EVA_Player_Cover(maxWidth,maxHeight),totalImgCount_=0,img_previewer;this.applyTemplate=function(e){LOG.trace(__LOG_TAG__,"apply template(file:"+e.script+", Obj:"+e.object+")"),null!=realPlayerObj_&&realPlayerObj_.stop();var t=document.getElementById(player_canvas_id_);t.innerHTML="";var i=g_images[0].src;loader_.show(g_album_info.title,g_album_info.create_time,i),loader_.setRange(totalImgCount_),loader_.updateProgress(totalImgCount_-loadingImgCount_),img_previewer=new ImagePreviewer(t,canvasWidth_,canvasHeight_),template_script_ready_=!1,loadJSFile(e.script,function(){LOG.trace(__LOG_TAG__,"album template script loaded"),template_script_ready_=!0},function(){LOG.error(__LOG_TAG__,"load album template script failed!"),QOS_Err("LoadTemplateScriptFail",{id:e.id,file:e.script}),showException("出错啦，请稍后重试~")}),real_playerCreator_=e.object,check_body_scroll()},this.setBkMusic=function(e,t){void 0!=e&&""!=e&&(TTXP_BGM.load(e),t===!0&&TTXP_BGM.play())},this.addMedia=function(e){"url"==e.location?(__addImgByUrl(e.url),TTXP.imgMgr.append(e)):"serverId"==e.location&&__addImgByServerId(e.url)},this.previewImage=function(e){img_previewer.preview(e,g_images)},this.play=function(){LOG.trace(__LOG_TAG__,"play"),__checkIsReady(__realPlay)};var __addImgByUrl=function(e){totalImgCount_++,loadingImgCount_++,g_images.push({src:e}),loadingImgCount_--,null!=loader_&&loader_.updateProgress(totalImgCount_-loadingImgCount_)},_onWxImgloaded=function(e,t,i){if(LOG.trace(__LOG_TAG__,"wx img loaded, ret="+e+", id="+t),loadingImgCount_--,1==e){var n=new Image;n.src=i,g_images.push(n)}null!=loader_&&loader_.updateProgress(totalImgCount_-loadingImgCount_)},__addImgByServerId=function(e){totalImgCount_++,loadingImgCount_++,wxAPI.downloadImage(e,_onWxImgloaded)},__createStage=function(){LOG.trace(__LOG_TAG__,"create stage");for(var album_info={canvas_id:player_canvas_id_,max_width:canvasWidth_,max_height:canvasHeight_,title:g_album_info.title,music:g_album_info.music,create_time:g_album_info.create_time,images:[]},i=0;i<g_images.length;++i)album_info.images.push({src:g_images[i].src});console.log(JSON.stringify(album_info));var func_str="realPlayerObj_ = new "+real_playerCreator_+"(album_info);";try{eval(func_str)}catch(e){console.log("exception when create template, msg:"+e.message+", desc:"+e.description)}},__realPlay=function(){LOG.trace(__LOG_TAG__,"real begin play"),realPlayerObj_.play(),TTXP_Create_Guide.show(),$(".editor_btn_section").each(function(e){var t=this;window.setTimeout(function(){$(t).show()},10+100*e)})},__checkIsReady=function(e){0==loadingImgCount_&&1==template_script_ready_?(LOG.trace(__LOG_TAG__,"Finished load images, begin play. Total:"+totalImgCount_+", Fail:"+(totalImgCount_-g_images.length)),__createStage(),loader_.hide(e)):window.setTimeout(function(){__checkIsReady(e)},100)}}function EVA_CSS_Loader(e,t,i,n){var a,o,r,l=!1,s=!1,_=function(){1!=s&&1!=l&&(l=!0,log("trace","[CSSLoader]load "+e+" finished, ready to go!"),clearInterval(a),clearTimeout(o),r&&void 0!=r&&(r.parentNode.removeChild(r),r=void 0),t())},c=function(){1!=s&&1!=l&&(s=!0,log("error","[CSSLoader]load "+e+" failed!"),clearInterval(a),clearTimeout(o),r&&void 0!=r&&(r.parentNode.removeChild(r),r=void 0),i())},u=function(e,t){return e.currentStyle?e.currentStyle[t]:e.ownerDocument.defaultView.getComputedStyle(e,null)[t]};this.load=function(){var t=document.createElement("link");t.rel="stylesheet",t.type="text/css",t.href=e,o=setTimeout(function(){log("error","[CSSLoader]load "+e+" timeout.!"),c()},3e4),r=document.createElement("div"),r.id=n,document.body.appendChild(r),a=setInterval(function(){"none"===u(r,"display")&&_()},50);var i=document.head||document.getElementsByTagName("head")[0];i.appendChild(t)}}function loadCSSFile(e,t,i,n){var a=new EVA_CSS_Loader(e,t,i,n);a.load()}function preventTouch(e){e.preventDefault()}function enableBodyTouch(e){e?$unlisten(document,"touchmove",preventTouch):$listen(document,"touchmove",preventTouch)}function onDocReady(){traceTimeCost("doc ready");var e=document.body.scrollWidth,t=document.body.scrollHeight;$("#div_player").width(e).height(t),TTXP.init(),TTXP_BGM.init({obj:$("#music_bkgnd")[0],ready:function(){},play:function(){$("#wraper_music").show(),$("#btn_play_music").attr("class","c_btn_play_music_playing")},pause:function(){$("#btn_play_music").attr("class","c_btn_play_music_paused")}}),TTXP_UI.LoadingToast.show("数据加载中...");var i=getUrlParams();getAlbumInfo(i.id,function(i,n,a){if(traceTimeCost("getAlbumInfo"),console.log("res get album info"),TTXP_UI.LoadingToast.hide(),i===!0){g_album_info=a,isEditMode(g_album_info)?_runEditMode():_runPlayerMode(),g_albumPlayer=new EVA_Player("div_player",e,t);var o=g_album_info.template.music;void 0!=g_album_info.music&&""!=g_album_info.music&&(o=g_album_info.music),g_albumPlayer.setBkMusic(o,!1);for(var r=0;r<g_album_info.media_list.length;++r)g_albumPlayer.addMedia(g_album_info.media_list[r]);g_albumPlayer.applyTemplate(g_album_info.template),g_albumPlayer.play(),document.title=g_album_info.title,weixin_share_api.setShareImg(g_album_info.media_list[0].url),weixin_share_api.setAlbumTitle(g_album_info.title),g_album_info.share_desc&&weixin_share_api.setShareDesc(g_album_info.share_desc),wxAPI.init(!1,function(e){traceTimeCost("wx api ret"),console.log("wx ready, ret:"+e),1==e&&wx.showOptionMenu(),weixin_share_api.init(!1),__play_bgm()},!1,"undefined"!=typeof wx_jsapi_sig?wx_jsapi_sig:null);var l=traceTimeCost("play");"undefined"!=typeof wx_jsapi_sig?QOS_Stat("VIEW_READY_2.0",l):QOS_Stat("VIEW_READY_1.0",l)}else showException("您所查看的炫拍可能已经被删除!"),QOS_Error("GetAlbumInfoFail")},!1);var n=i.biz||"TTXP";TTXP.setBizId(n),TTXP_BIZ_MGR.init(function(){var e="";i.guide_type&&"1"===i.guide_type?e="http://mp.ttxuanpai.com/create.php?biz="+n:isAlbumOwner()?(e=TTXP_BIZ_MGR.getFollowGuide(TTXP_BIZ_MGR.randomParter(n)),QOS_Stat("VIEW_Host",0),console.log("view as host")):(e=TTXP_BIZ_MGR.getFollowGuide(n),QOS_Stat("VIEW_Guest",0),console.log("view as guest")),weixin_share_api.setShareJump(e),$("#div_player_btn_more").attr("href",e)}),reportData("pageView","eva_album.html")}function getAlbumInfo(e,t){if(console.log("get album info, uid="+getUID()+", album_id="+e),"undefined"!=typeof g_album_info_res)if("0"==g_album_info_res.ret){var i=g_album_info_res.data;i.title=decodeURIComponent(i.title),i.share_desc=decodeURIComponent(i.share_desc?i.share_desc:""),i.id=e,t(!0,"",i)}else console.log("Request album info failed, ret:%s, msg:%s",g_album_info_res.ret,g_album_info_res.msg),t(!1,g_album_info_res.msg,{});else $.ajax({url:"http://api.ttxuanpai.com/cgi-bin/get_album_info",type:"GET",dataType:"json",timeout:15e3,data:{id:e,uid:getUID()},error:function(){t(!1,"出错啦，请稍后重试!",{})},fail:function(){t(!1,"出错啦，请稍后重试!",{})},success:function(i){if(console.log("get album info:"+JSON.stringify(i)),"0"==i.ret){var n=i.data;n.title=decodeURIComponent(n.title),n.share_desc=decodeURIComponent(n.share_desc?n.share_desc:""),n.id=e,t(!0,"",n)}else console.log("Request album info failed, ret:%s, msg:%s",i.ret,i.msg),t(!1,i.msg,{})}})}function _runEditMode(){var e=document.body.scrollHeight;$("#div_editor").height(e).show(),TTXP_ALBUM_MUSIC_LIST.init(),TTXP_ALBUM_TMPL_LIST.init(),AlbumEditPageMgr.push("div_change_template","editor_change_template","换模板",e-40,null,onTemplateContentShow),AlbumEditPageMgr.push("div_change_music","music_list_wrapper","选音乐",e-40,onAlbumMusicSelect,onMusicContentShow),AlbumEditPageMgr.push("div_change_content","editor_change_content","改标题",e-40,onSaveTitle,onTextContentShow),AlbumEditPageMgr.push("div_change_picture","edit_page_image","加照片",e-40,onSaveImage,onImageContentShow)}function _runPlayerMode(){TTXP_Create_Guide.enable(!0),$("#div_editor").remove()}function onPlayMusic(){1==TTXP_BGM.paused()?TTXP_BGM.play():TTXP_BGM.pause()}function log(e,t){console.log("["+e+"]"+t)}function reportData(e,t){console.log("reportData, type:"+e+", value:"+t);var i=getUrlParams(),n=new XMLHttpRequest,a="http://qos.ttxuanpai.com/data/report";n.open("POST",a,!0),n.setRequestHeader("Content-type","application/json");var o={type:e,data:{album_id:i.id,value:t}};n.send(JSON.stringify(o))}function traceTimeCost(e){var t=new Date,i=t.getTime()-__time_begin.getTime();return console.log("[PERF]#"+e+": "+i+"ms"),i}function isEditMode(e){if(e&&0==e.status){var t=getUrlParams();return!(t&&"true"==t.readonly)}return!1}function showException(e){$("#btn_create_album").click(function(){TTXP_DA.click("album.view.error.create"),location.href="create.php"}),$("#div_error").height(document.body.scrollHeight).show(),$("#txt_error_desc").text(e),TTXP_BGM.stop()}function isAlbumOwner(){return g_album_info&&0==g_album_info.status}function __play_bgm(){TTXP_BGM.set_ready(),TTXP_BGM.play(),document.removeEventListener("touchstart",__play_bgm,!1)}function begin_play_bgm(){document.addEventListener("WeixinJSBridgeReady",function(){console.log("WeixinJSBridgeReady"),__play_bgm()},!1),document.addEventListener("YixinJSBridgeReady",function(){console.log("YixinJSBridgeReady"),__play_bgm()},!1),document.addEventListener("touchstart",__play_bgm(),!1)}function check_body_scroll(){g_album_info&&"2.0"==g_album_info.template.version&&(enableBodyTouch(!0),$("#div_player").css("overflow-y","auto"))}function ImagePreviewer(e,t,i){function n(){console.log("close img viewer"),c.className="img_viewer_hide",c.style["pointer-events"]="none"}function a(){var e=r(u.width,u.height);o(e)}function o(e){u.style.left=parseInt((t-e.width)/2)+"px",u.style.top=parseInt((i-e.height)/2)+"px",u.style.width=e.width+"px",u.style.height=e.height+"px"}function r(e,t){var i=e,n=t,a=i,o=n;return(i>s||n>_)&&(a=Math.floor(_*i/n),s>=a?o=_:(o=Math.floor(n*s/i),a=s)),{width:a,height:o}}function l(e){for(var t in g_images)if(g_images[t].src==e)return g_images[t];return null}var s=i>t?t-4:t-30,_=i>t?i-4:i-30,c=document.createElement("div");c.id="img_viewer",c.style.width=t+"px",c.style.height=i+"px",c.innerHTML='<img src="">',c.onclick=n;var u=c.getElementsByTagName("img")[0];u.onload=a,e.appendChild(c),this.preview=function(e,t){var i=l(e);console.log("preview image:"+i.src),c.style.display="block",c.className="img_viewer_show",c.style["pointer-events"]="auto",u.src=i.src;var n=r(i.width,i.height);o(n)}}function EVA_JS_Loader(e,t,i){this.load=function(){console.log("trace","load js file:"+e),jQuery.getScript(e).done(function(){t()}).fail(function(){var n=document.createElement("script");n.setAttribute("type","text/javascript"),n.setAttribute("src",e),n.onload=function(){console.log("Js File load successed"),t()},n.onerror=function(){console.log("Js File load failed!"),i()};var a=document.head||document.getElementsByTagName("head")[0];a.appendChild(n)})}}function loadJSFile(e,t,i){var n=new EVA_JS_Loader(e,t,i);n.load()}var TTXP_BGM=new function(){function e(){LOG.trace(i,"begin play"),r=!1,t.obj.play();var e,n,a;window.setTimeout(function(){r?(QOS_Stat("WithBGM_1",0),window.clearTimeout(e),window.clearTimeout(n),window.clearTimeout(a)):QOS_Err("NoBGM_1",{file:t.obj.src})},1e3),e=window.setTimeout(function(){r?(QOS_Stat("WithBGM_3",0),window.clearTimeout(n),window.clearTimeout(a)):QOS_Err("NoBGM_3",{file:t.obj.src})},3e3),n=window.setTimeout(function(){r?(QOS_Stat("WithBGM",0),window.clearTimeout(a)):QOS_Err("NoBGM",{file:t.obj.src})},5e3),a=window.setTimeout(function(){r?QOS_Stat("WithBGM_10",0):QOS_Err("NoBGM_10",{file:t.obj.src})},1e4)}var t,i="BGM",n=!1,a=!1,o=!1,r=!1,l=!1;this.init=function(e){t=e,t.obj=new Audio,$(t.obj).bind("ended",function(){LOG.trace(i,"on play ended"),a&&(t.obj.load(),t.obj.play())}).bind("error",function(){LOG.error(i,"on play error"),QOS_Err("LoadMusicFail",{file:t.obj.src})}).bind("playing",function(){LOG.trace(i,"begin really play, play ing"),r=!0,t&&t.play&&t.play()}).bind("canplay",function(){LOG.trace(i,"can play"),o=!0});var n=this;window.setTimeout(function(){l||(console.log("bgm over time, auto play"),n.set_ready(),n.play())},1e4)},this.set_ready=function(){LOG.trace(i,"set ready"),n=!0,n||t&&t.ready&&t.ready()},this.load=function(e){LOG.trace(i,"load:"+e),o=!1,""!=e&&(a=!0,t.obj.src=e,t.obj.load())},this.play=function(){LOG.trace(i,"request play"),l||(e(),l=!0)},this.stop=function(){this.pause()},this.pause=function(){LOG.trace(i,"pause"),t.obj.pause(),t&&t.pause&&t.pause(),l=!1},this.paused=function(){return t.obj.paused}},g_images=[],TTXP_BIZ_MGR=new function(){var e={};this.init=function(t){jQuery.getScript("http://mp.ttxuanpai.com/static/biz_config.js?t="+parseInt(Date.now()/3e5)).done(function(){try{for(var i=0;i<TTXP_BIZ_CONFIG.length;++i)e[TTXP_BIZ_CONFIG[i].id]=TTXP_BIZ_CONFIG[i];t()}catch(n){QOS_Error("GetBizConfig")}}).fail(function(){QOS_Error("GetBizConfig"),t()})},this.getFollowGuide=function(t){if(t in e){if("follow_guide"in e[t])return e[t].follow_guide}else QOS_Error("InvalidBiz");return"http://mp.weixin.qq.com/s?__biz=MzAwNTI1MDE0MA==&mid=100000311&idx=1&sn=76fac526861f05e68474415331b21ca9#rd"},this.randomParter=function(t){if(t in e){var i=e[t];if("partners"in i&&i.partners.length>0){var n=parseInt(Math.random()*i.partners.length);return i.partners[n]}return t}return t}},g_albumPlayer;$(document).ready(function(){enableBodyTouch(!1),onDocReady()});var TTXP_Create_Guide=new function(){var e=!1;this.enable=function(t){e=t},this.show=function(){e&&($("#div_player_mask").show(),$("#div_player_footer").addClass("effect_fadeIn").show(),t())};var t=function(){window.setTimeout(function(){var e=$("#div_player_footer").find(".guide_ornament").show(),i=["kf_fadeInUp","kf_fadeIn","kf_bounceInUp"],n=["kf_tada","kf_shake"];TTXP_Animation_Mgr.animate(e[0],{animates:[{name:i[parseInt(Math.random()*i.length)],duration:1.5,delay:0,timing:"ease"},{name:n[parseInt(Math.random()*n.length)],duration:1.5,delay:1,timing:"ease"},{name:"kf_fadeOut",duration:2.5,delay:3,timing:"ease"}],end:function(){t()}})},3e3+7e3*Math.random())}},TTXP=new function(){var e="",t=5,i=!1;this.init=function(){n()};var n=function(){$("#playendtips_replay").click(function(){$("#wrapper_play_end").hide(),TTXP_DA.click("album.view.play.endtip.replay")}),$("#playendtips_stop").click(function(){TTXP_DA.click("album.view.play.endtip.stop"),window.close(),wx.closeWindow()})},a=function(){$("#playendtips_replay").text("继续播放("+t+"s)"),0==t?$("#wrapper_play_end").hide():(t--,window.setTimeout(a,1e3))};this.showPlayEndTips=function(){if(i=!0,!isEditMode(g_album_info)){$("#playendtips_title").text(g_album_info.title);var e=new Date;e.setTime(1e3*g_album_info.create_time),$("#playendtips_date").text(e.getFullYear()+"年"+(e.getMonth()+1)+"月"+e.getDate()+"日"),$("#wrapper_play_end").show(),t=10,a()}},this.isPlayEndTipsShowed=function(){return i},this.setBizId=function(t){e=t},this.getBizId=function(){return e},this.imgMgr=new function(){var e="TTXP_ImageMgr",t=[],i=0;this.append=function(i){LOG.trace(e,"append:"+i),i&&i.url&&i.url.length>0&&t.push({url:i.url,desc:i.desc?decodeURIComponent(i.desc):""})},this.getNextImg=function(){return t.length<1?null:t[i++%t.length]},this.isAllImgDisplayed=function(){return i>t.length},this.getImgCount=function(){return t.length},this.getDisplayedImgCount=function(){return i},this.getImg=function(e){return e<t.length?t[e]:null}}},weixin_share_api=new function(){var e="http://mp.weixin.qq.com/s?__biz=MzAwNTI1MDE0MA==&mid=100000311&idx=1&sn=76fac526861f05e68474415331b21ca9#rd",t=e,i="http://cdn.ttxuanpai.com/images/icon.png",n="天天炫拍",a="天天炫拍",o="精彩的图片，炫丽的相册，打开看看吧~";this.init=function(e){console.log("init wexin_share_api");var a=location.href.replace(/uid=[^&]+&?/,"").replace(/openid=[^&]+&?/,""),r=function(e,n){console.log("share result, type="+e+", result="+n+", img="+i+", url="+a),1==n?(reportData(e,"1"),QOS_Report("followGuide",e),window.setTimeout(function(){location.href=t},100)):reportData(e,"-1")};wx.onMenuShareTimeline({title:n,link:a,imgUrl:i,success:function(){r("shareToTimeline",!0)},cancel:function(){r("shareToTimeline",!1)}}),wx.onMenuShareAppMessage({title:n,desc:o,link:a,imgUrl:i,type:"link",dataUrl:"",success:function(){r("shareToFriends",!0)},cancel:function(){r("shareToFriends",!1)}}),wx.onMenuShareQQ({title:n,desc:o,link:a,imgUrl:i,success:function(){r("shareToQQ",!0)},cancel:function(){r("shareToQQ",!1)}}),wx.onMenuShareWeibo({title:n,desc:o,link:a,imgUrl:i,success:function(){r("shareToWeibo",!0)},cancel:function(){r("shareToWeibo",!1)}}),wx.onMenuShareQZone({title:n,desc:o,link:a,imgUrl:i,success:function(){r("shareToQZone",!0)},cancel:function(){r("shareToQZone",!1)}})},this.setShareJump=function(e){console.log("Set wx share jump url:"+e),t=e},this.setShareImg=function(e){console.log("setShareImg:"+e),i=e},this.setAlbumTitle=function(e){console.log("setAlbumTitle:"+e),n=a=e},this.setShareDesc=function(e){e&&void 0!=e&&""!=e&&(o=e)}};